<div id="shift-detail-root">
    <div class="header">
        <button class="btn-back-header" data-bind="click: goBack">戻る</button>
    </div>

    <div data-bind="visible: error()" style="color:#d33; padding: 10px; background: #ffe6e6; margin: 10px;">
        <span data-bind="text: error()"></span>
    </div>

    <div data-bind="visible: loading()" class="loading">
        読み込み中...
    </div>


    <div data-bind="visible: isReady()" class="main-content" style="display: flex; gap: 20px;">
        <div class="left-section" style="flex: 1;">
            <div class="shift-basic-info">
            
            
                        <!-- 日表示の情報を追加 -->
                        <div class="shift-details">
                            <!-- シフト情報 -->
                            <div class="shift-info">
                                <div class="shift-info-content">
                                    <p style="color: #444444; font-size: 18px; font-weight: bold;" id="shift-free-text">シフト情報なし</p>
                                    <p class="shift-id" style="color: #444444; font-size: 16px; font-weight: bold;"><span id="shift-created-by"></span>より</p>
                                    
                                    <!-- 定員状況 -->
                                    <div class="shift-capacity" style="display: block !important; visibility: visible !important; margin: 10px 0; padding: 10px; background: #f8f9fa; border-radius: 4px;">
                                        <h4 style="color: #333333; margin: 0 0 10px 0; font-size: 16px; font-weight: bold;">定員状況</h4>
                                        <div class="capacity-info" style="color: #333333; font-size: 16px; font-weight: 500;">
                                            <span id="capacity-assigned">0</span> / 
                                            <span id="capacity-total">0</span>人
                                            <span id="capacity-status" style="margin-left: 10px;"></span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
        
        <div class="participants-section">
            <h3>参加者一覧</h3>
            <div class="participants-list">
                <!-- ko foreach: participants -->
                <div class="participant-item" style="display: flex; align-items: center; margin: 5px 0; padding: 8px; border-radius: 4px; background: #f9f9f9;">
                    <!-- カラー表示 -->
                    <div class="participant-color" style="width: 12px; height: 12px; border-radius: 50%; margin-right: 8px; flex-shrink: 0;" data-bind="style: { backgroundColor: $data.color }"></div>
                    <!-- 名前と一言 -->
                    <div style="flex: 1; display: flex; align-items: center; gap: 8px;">
                        <div class="participant-name" style="font-weight: bold; color: #333;" data-bind="text: $data.name"></div>
                        <!-- ko if: $data.self_word && $data.self_word.trim() !== '' -->
                        <div class="participant-comment" style="font-style: italic; color: #666; font-size: 0.9em;" data-bind="text: $data.self_word"></div>
                        <!-- /ko -->
                    </div>
                    <!-- 参加状況 -->
                    <div class="participant-status" style="margin-left: 8px; padding: 2px 6px; border-radius: 12px; font-size: 0.8em; font-weight: bold;" 
                         data-bind="text: $data.status === 'assigned' ? '参加' : ($data.status === 'cancelled' ? '欠席' : $data.status)"></div>
                </div>
                <!-- /ko -->
                <!-- ko if: participants().length === 0 -->
                <div class="no-participants" style="color: #999;">
                    参加者なし
                </div>
                <!-- /ko -->
            </div>
            </div>
        </div>
        
        <div class="right-section" style="flex: 1;">
            <div class="action-buttons">
            <h3>操作</h3>
            
            <!-- 編集ボタン（作成者のみ表示） -->
            <div class="button-container" style="display: flex; gap: 10px; flex-wrap: wrap; margin-bottom: 20px;">
                <button type="button" class="action-btn btn-edit" 
                        data-bind="visible: shift() && shift().created_by == currentUserId, 
                                   click: editShift"
                        style="background: #28a745; color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer; font-size: 16px; font-weight: bold;">
                    編集
                </button>
            </div>
            
            <h3>参加/取り消し</h3>
            <!-- ボタンコンテナ -->
            <div class="button-container" style="display: flex; gap: 10px; flex-wrap: wrap;">
                <!-- 参加ボタン（定員に空きがある時のみ表示） -->
                <button type="button" class="action-btn btn-participate" 
                        data-bind="visible: shift() && canParticipate(), 
                                   click: joinShift"
                        style="background: #007bff; color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer; font-size: 16px; font-weight: bold;"
                        onclick="console.log('参加ボタンクリック！');">
                    参加
                </button>
                
                <!-- 取消ボタン（参加している時のみ表示） -->
                <button type="button" class="action-btn btn-cancel" 
                        data-bind="visible: shift() && isParticipating(),
                                   click: cancelShift"
                        style="background: #dc3545; color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer; font-size: 16px; font-weight: bold;"
                        onclick="
                            console.log('=== 取消ボタン直接クリック ===');
                            console.log('ViewModel exists:', !!window.__shiftVM);
                            console.log('cancelShift function exists:', !!(window.__shiftVM && window.__shiftVM.cancelShift));
                            if (window.__shiftVM && window.__shiftVM.cancelShift) {
                                console.log('Calling cancelShift directly...');
                                window.__shiftVM.cancelShift();
                            } else {
                                console.error('cancelShift function not found');
                            }
                        ">
                    取消
                </button>
                
            </div>
            
            
        </div>
        
        <div class="recruitment-times">
            <h3>シフト情報</h3>
            <ul class="recruitment-details">
                <li>開始時刻: <span data-bind="text: shift() ? shift().start_time : ''"></span></li>
                <li>終了時刻: <span data-bind="text: shift() ? shift().end_time : ''"></span></li>
                <li>シフト作成者ID: <span id="shift-created-by-bottom"></span></li>
            </ul>
        </div>
        
    </div>
    </div>
    
    <!-- 詳細ページ用モーダル -->
    <div id="comment-modal-view" class="modal-overlay" style="position: fixed !important; top: 0 !important; left: 0 !important; width: 100% !important; height: 100% !important; background: rgba(0,0,0,0.8) !important; z-index: 99999 !important; display: none !important; align-items: center !important; justify-content: center !important;">
        <div onclick="event.stopPropagation()" style="background: white; border-radius: 15px; padding: 30px; max-width: 500px; width: 90%; box-shadow: 0 0 30px rgba(0,0,0,0.5); position: relative;">
            <button onclick="window.__shiftVM.hideCommentModal()" style="position: absolute; top: 10px; right: 15px; background: none; border: none; font-size: 24px; cursor: pointer; color: #666;">×</button>
            <h3 style="margin: 0 0 20px 0; color: #333; font-size: 20px;">参加時のひとこと（任意）</h3>
            <textarea id="comment-textarea-view" rows="4" style="width: 100%; padding: 10px; border: 2px solid #ddd; border-radius: 5px; font-size: 16px; resize: vertical;" placeholder="例：頑張ります！"></textarea>
            <div style="margin-top: 20px; text-align: right;">
                <button id="comment-cancel-btn-view" style="background: #ccc; color: #333; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer; margin-right: 10px; font-size: 16px;">キャンセル</button>
                <button id="comment-ok-btn-view" style="background: #007bff; color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer; font-size: 16px; font-weight: bold;">参加する</button>
            </div>
        </div>
    </div>

    <!-- シフト編集用モーダル -->
    <div id="edit-shift-modal" class="modal-overlay" style="position: fixed !important; top: 0 !important; left: 0 !important; width: 100% !important; height: 100% !important; background: rgba(0,0,0,0.8) !important; z-index: 99999 !important; display: none !important; align-items: center !important; justify-content: center !important;">
        <div onclick="event.stopPropagation()" style="background: white; border-radius: 15px; padding: 30px; max-width: 600px; width: 90%; max-height: 90vh; overflow-y: auto; box-shadow: 0 0 30px rgba(0,0,0,0.5); position: relative;">
            <button onclick="window.__shiftVM.hideEditModal()" style="position: absolute; top: 10px; right: 15px; background: none; border: none; font-size: 24px; cursor: pointer; color: #666;">×</button>
            <h3 style="margin: 0 0 20px 0; color: #333; font-size: 20px;">シフト情報編集</h3>
            
            <form id="edit-shift-form">
                <div class="form-group" style="margin-bottom: 20px;">
                    <label for="edit-shift-date" style="display: block; margin-bottom: 5px; font-weight: bold; color: #333;">日付</label>
                    <input type="date" id="edit-shift-date" name="shift_date" required style="width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 4px; font-size: 16px; box-sizing: border-box;">
                    <div style="font-size: 14px; color: #666; margin-top: 5px;">シフトの実施日を選択してください</div>
                </div>
                
                <div style="display: flex; gap: 15px; margin-bottom: 20px;">
                    <div class="form-group" style="flex: 1;">
                        <label for="edit-start-time" style="display: block; margin-bottom: 5px; font-weight: bold; color: #333;">開始時刻</label>
                        <input type="time" id="edit-start-time" name="start_time" required style="width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 4px; font-size: 16px; box-sizing: border-box;">
                    </div>
                    
                    <div class="form-group" style="flex: 1;">
                        <label for="edit-end-time" style="display: block; margin-bottom: 5px; font-weight: bold; color: #333;">終了時刻</label>
                        <input type="time" id="edit-end-time" name="end_time" required style="width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 4px; font-size: 16px; box-sizing: border-box;">
                    </div>
                </div>
                
                <div class="form-group" style="margin-bottom: 20px;">
                    <label for="edit-recruit-count" style="display: block; margin-bottom: 5px; font-weight: bold; color: #333;">募集人数</label>
                    <input type="number" id="edit-recruit-count" name="recruit_count" min="1" max="100" required style="width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 4px; font-size: 16px; box-sizing: border-box;">
                    <div style="font-size: 14px; color: #666; margin-top: 5px;">何人まで参加可能かを設定してください</div>
                </div>
                
                <div class="form-group" style="margin-bottom: 20px;">
                    <label for="edit-free-text" style="display: block; margin-bottom: 5px; font-weight: bold; color: #333;">自由記述</label>
                    <textarea id="edit-free-text" name="free_text" rows="4" maxlength="500" placeholder="シフトの詳細や注意事項などを記載してください" style="width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 4px; font-size: 16px; box-sizing: border-box; resize: vertical; min-height: 80px;"></textarea>
                    <div style="font-size: 14px; color: #666; margin-top: 5px;">500文字以内で入力してください</div>
                </div>
                
                <div style="margin-top: 30px; text-align: center;">
                    <button type="button" id="edit-shift-cancel-btn" style="background: #6c757d; color: white; border: none; padding: 12px 24px; border-radius: 4px; cursor: pointer; margin-right: 10px; font-size: 16px;">キャンセル</button>
                    <button type="submit" id="edit-shift-submit-btn" style="background: #007bff; color: white; border: none; padding: 12px 24px; border-radius: 4px; cursor: pointer; font-size: 16px; font-weight: bold;">更新</button>
                </div>
            </form>
        </div>
    </div>
    </div>
</div>